<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login (Debug) | CXPS Collaboration</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif; margin: 24px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); max-width: 720px; }
    .btn { padding: 10px 14px; border-radius: 8px; border: 1px solid #e5e7eb; background: #f9fafb; cursor: pointer; }
    .btn:hover { background: #f3f4f6; }
    input[type="email"] { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #e5e7eb; }
    .muted { color: #6b7280; }
    pre { background:#0b1021; color:#e3e8ff; padding:12px; border-radius:8px; overflow:auto; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, setPersistence, browserLocalPersistence,
             isSignInWithEmailLink, sendSignInLinkToEmail,
             signInWithEmailLink, onAuthStateChanged, signOut } 
      from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

    // ▼▼ Firebase コンソールの SDK 設定を貼り付けてください ▼▼
    const firebaseConfig = {
      apiKey: "AIzaSyBNssRe0SUmvvJ5t5UUnqDCnTTF1Q-WD8c",
      authDomain: "gcp-cxjapancollabor-nprd-88957.web.app",
      projectId: "gcp-cxjapancollabor-nprd-88957",
      appId: "1:659563877036:web:b0e04146aa1002f5898509"
    };
    // ▲▲ ここまで ▲▲

    // デバッグ：空配列ならドメイン制限をスキップ（まずは動作確認を優先）
    const ALLOWED_DOMAINS = []; // 例: ["example.co.jp"]
    const allowDomain = (email) => {
      if (!email) return false;
      if (ALLOWED_DOMAINS.length === 0) return true;
      return ALLOWED_DOMAINS.some(d => email.toLowerCase().endsWith("@"+d.toLowerCase()));
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    setPersistence(auth, browserLocalPersistence);

    const log = (msg, obj) => {
      const el = document.getElementById('log');
      const ts = new Date().toISOString();
      let line = ts + " " + msg;
      if (obj) line += "\n" + JSON.stringify(obj, null, 2);
      el.textContent += line + "\n";
      console.log(msg, obj || "");
    };

    window.sendLink = async () => {
      const email = document.getElementById('email').value.trim();
      log("sendLink clicked with email", { email });
      if (!allowDomain(email)) {
        alert("社内メールのみ許可されています / Allowed domains NG");
        log("allowDomain=false");
        return;
      }
      const acs = { url: window.location.origin + "/login.html", handleCodeInApp: true };
      log("actionCodeSettings", acs);
      try {
        await sendSignInLinkToEmail(auth, email, acs);
        window.localStorage.setItem('emailForSignIn', email);
        document.getElementById('status').textContent = "サインイン用リンクを送信しました。メールをご確認ください。";
        log("sendSignInLinkToEmail SUCCESS");
      } catch (e) {
        alert("ERROR: " + e.message + "\n(code=" + e.code + ")");
        log("sendSignInLinkToEmail ERROR", { code: e.code, message: e.message, name: e.name, stack: e.stack });
      }
    };

    if (isSignInWithEmailLink(auth, window.location.href)) {
      let email = window.localStorage.getItem('emailForSignIn') || window.prompt('社内メールアドレスを入力してください:');
      log("isSignInWithEmailLink=true, email=" + email);
      if (!allowDomain(email)) {
        alert("社内メールのみ許可されています");
        log("allowDomain=false during complete");
      } else {
        signInWithEmailLink(auth, email, window.location.href)
          .then(() => {
            window.localStorage.removeItem('emailForSignIn');
            document.getElementById('status').textContent = "サインイン完了しました。ポータルを開いてください。";
            log("signInWithEmailLink SUCCESS");
          })
          .catch(err => {
            alert("ERROR: " + err.message + "\n(code=" + err.code + ")");
            log("signInWithEmailLink ERROR", { code: err.code, message: err.message, name: err.name, stack: err.stack });
          });
      }
    }

    onAuthStateChanged(auth, (user) => {
      document.getElementById('loading').style.display = 'none';
      const signed = document.getElementById('signed');
      const form = document.getElementById('form');
      if (user) {
        signed.style.display = 'block';
        form.style.display = 'none';
        document.getElementById('who').textContent = user.email || "(signed-in)";
        log("onAuthStateChanged: signed-in", { email: user.email });
      } else {
        signed.style.display = 'none';
        form.style.display = 'block';
        log("onAuthStateChanged: signed-out");
      }
    });

    window.doLogout = () => signOut(auth);
  </script>
</head>
<body>
  <h1>ログイン（デバッグ用）</h1>
  <div class="card muted">
    <strong>まずはここを確認：</strong>
    <ol>
      <li>Firebase Console → Authentication → サインイン方法で「Email/Password」「Email link (passwordless)」が <strong>ON</strong> か。</li>
      <li>Authenocstication → 設定 → <strong>Authorized domains</strong> に <code>.cxj-collab.cdm</code> と <code>&lt;projectId&gt;.firebaseapp.com</code> が入っているか。</li>
      <li>このページで <code>firebaseConfig</code>（apiKey / authDomain / projectId / appId）が <strong>正しく差し替え済み</strong>か。</li>
    </ol>
  </div>

  <div id="loading" class="card">Loading...</div>

  <div id="form" class="card" style="display:none;">
    <p class="muted">社内メールアドレスにサインインリンクを送付します。</p>
    <input id="email" type="email" placeholder="your.name@company.co.jp" />
    <button class="btn" onclick="sendLink()">リンクを送る</button>
  </div>

  <div id="signed" class="card" style="display:none;">
    <div>Signed in as: <strong id="who"></strong></div>
    <p id="status" class="muted">サインイン済みです。以下のボタンからポータルを開いてください。</p>
    <a class="btn" href="/" target="_blank">ポータルを開く</a>
    <button class="btn" onclick="doLogout()">Sign out</button>
  </div>

  <h3>Debug Log</h3>
  <pre id="log"></pre>
</body>
</html>
