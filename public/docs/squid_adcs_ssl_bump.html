<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Squid + ADCS ã§ SSL Bump ã‚’æ§‹æˆã™ã‚‹æ‰‹é †ï¼ˆç¤¾å†…å‘ã‘ï¼‰</title>
  <style>
    body { font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, Arial, sans-serif; background:#ffffff; color:#111; line-height:1.75; margin:0; }
    main { max-width: 960px; margin: 24px auto; padding: 24px; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.06); background:#fff; }
    h1 { color:#0b4a6f; margin:0 0 12px; }
    h2 { color:#0b4a6f; margin:24px 0 8px; }
    h3 { color:#0b4a6f; margin:16px 0 6px; }
    p { margin: 0 0 12px; }
    ul, ol { margin: 0 0 12px 20px; }
    pre { background:#ffffff; color:#111; border:1px solid #cbd5e1; border-radius:8px; padding:12px; overflow:auto; }
    pre code { background:none; font-family: Consolas, Menlo, Monaco, "Courier New", monospace; font-size:15px; line-height:1.4; display:block; white-space:pre; }
    table { width:100%; border-collapse:collapse; margin: 12px 0; font-size: 14px; }
    th, td { border:1px solid #e5e7eb; padding:8px; text-align:left; }
    th { background:#f1f5f9; }
    .note { background:#fff8e1; border-left:6px solid #facc15; padding:12px; border-radius:6px; margin:12px 0; }
    .checklist { background:#f8fafc; border:2px solid #e2e8f0; border-radius:8px; padding:12px; margin:12px 0; }
  </style>
</head>
<body>
<main>
  <h1>ğŸ” Squid + ADCS ã§ SSL Bump ã‚’æ§‹æˆã™ã‚‹æ‰‹é †ï¼ˆç¤¾å†…å‘ã‘ï¼‰</h1>

  <h2>ğŸ” æ¦‚è¦</h2>
  <p>ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€ç¤¾å†…ã® <strong>Active Directory Certificate Services (ADCS)</strong> ã‚’ç”¨ã„ã¦ã€<strong>Squid ãƒ—ãƒ­ã‚­ã‚·ã§ SSL Bumpï¼ˆHTTPS é€šä¿¡ã®ä¸­é–“è§£é‡ˆï¼‰</strong> ã‚’æ§‹æˆã™ã‚‹æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚</p>
  <p>ç›®çš„ã¯ã€ç¤¾å†…ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã® HTTPS ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’å¯è¦–åŒ–ãƒ»åˆ¶å¾¡ï¼ˆãƒãƒ«ã‚¦ã‚§ã‚¢æ¤œæŸ»ãƒ»URL ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç­‰ï¼‰ã™ã‚‹ã“ã¨ã§ã™ã€‚</p>

  <div class="note">âš ï¸ æ³¨æ„ï¼šSSL Bump ã¯æš—å·åŒ–é€šä¿¡ã‚’å¾©å·ã™ã‚‹ãŸã‚ã€ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒ»æ³•ä»¤ãƒ»ç¤¾å†…ãƒãƒªã‚·ãƒ¼ã«ååˆ†é…æ…®ã—ã¦ãã ã•ã„ã€‚</div>

  <h2>ğŸ§© å‰ææ¡ä»¶</h2>
  <ul>
    <li>ADCSï¼ˆEnterprise CAï¼‰ãŒç¨¼åƒã—ã¦ã„ã‚‹ã“ã¨</li>
    <li>ã‚µãƒ–CAè¨¼æ˜æ›¸ã‚’ç™ºè¡Œã§ãã‚‹æ¨©é™ãŒã‚ã‚‹ã“ã¨</li>
    <li>Squid 4.x ä»¥ä¸Šï¼ˆLinuxç’°å¢ƒï¼‰</li>
    <li><code>ssl_crtd</code> ãŒåˆ©ç”¨å¯èƒ½</li>
    <li>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ AD ãƒ‰ãƒ¡ã‚¤ãƒ³å‚åŠ æ¸ˆã¿ï¼ˆGPO é…å¸ƒãŒå¯èƒ½ï¼‰</li>
  </ul>

  <h2>ğŸ—ºï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦</h2>
  <pre><code>[Client]
   â”‚ HTTPS
   â–¼
[Squid Proxy (ssl_bump + CA cert + ssl_crtd)]
   â”‚ HTTPS
   â–¼
[Internet / Origin Server]
</code></pre>

<div style="text-align: center;"><img src="images/s1-1.png" alt="" width="608.8" height="202.4"></div><br>

  <p>Squid ã¯ ADCS ã‹ã‚‰ç™ºè¡Œã•ã‚ŒãŸã€Œã‚µãƒ–CAè¨¼æ˜æ›¸ã€ã‚’ä½¿ã„ã€HTTPS é€šä¿¡ã‚’å¾©å·ãƒ»å†æš—å·åŒ–ã—ã¾ã™ã€‚</p>

  <h2>âš™ï¸ æ§‹æˆãƒ‘ã‚¿ãƒ¼ãƒ³</h2>
  <table>
    <tr><th>æ–¹å¼</th><th>èª¬æ˜</th><th>æ¨å¥¨åº¦</th></tr>
    <tr><td>A. ã‚µãƒ–CAæ–¹å¼ï¼ˆæ¨å¥¨ï¼‰</td><td>ADCS ã‹ã‚‰ Squid ç”¨ã®ã‚µãƒ–CAè¨¼æ˜æ›¸ã‚’ç™ºè¡Œã—ä½¿ç”¨</td><td>â­â­â­â­â­</td></tr>
    <tr><td>B. è‡ªå·±ç½²åæ–¹å¼</td><td>Squid ãŒè‡ªå·±ç½²å CA ã‚’ä½œæˆã—ã€GPO ã§é…å¸ƒ</td><td>â­â­</td></tr>
  </table>

<h2>ğŸ§¾ ADCS å´ã®è¨­å®šï¼ˆã‚µãƒ–CAç™ºè¡Œï¼‰</h2>

<h3>CSR ç”Ÿæˆï¼ˆSquidå´ï¼‰</h3>
<p>ãƒ»Squidç”¨ã®ã‚µãƒ–CAè¨¼æ˜æ›¸ã‚’ç™ºè¡Œã™ã‚‹ãŸã‚ã®ã€Œè¨¼æ˜æ›¸ç½²åè¦æ±‚ï¼ˆCSRï¼‰ã€ã‚’ä½œæˆã—ã¾ã™ã€‚</p>
<p>ãƒ»CSRã®ç½²åç”¨ã«ã¾ãšç§˜å¯†éµ(â€»)ã‚’ä½œæˆã—ã€ãã®ç§˜å¯†éµã‚’æŒ‡å®šã—ã¦CSRã‚’ç™ºè¡Œã—ã¾ã™ã€‚</p>

<div class="note">â€»ç§˜å¯†éµã¯ã€SSL bumpæ™‚ã«å„ã‚µã‚¤ãƒˆç”¨ã®ã€Œå½ã‚µãƒ¼ãƒè¨¼æ˜æ›¸ã€ã‚’ç™ºè¡Œãƒ»ç½²åã™ã‚‹ãŸã‚ã®éµã¨ãªã‚Šã¾ã™ã€‚</div>

<pre><code>openssl genrsa -out squid_subca.key 4096

cat > ca_req.conf
[ req ]
default_bits       = 4096
prompt             = no
distinguished_name = dn
x509_extensions    = v3_ca

[ dn ]
C  = JP
ST = Tokyo
L  = Tokyo
O  = Cisco
OU = CXPS
CN = Squid-Proxy-SubCA

[ v3_ca ]
basicConstraints = critical, CA:TRUE, pathlen:0
keyUsage         = critical, cRLSign, keyCertSign
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer

openssl req -new -key squid_subca.key -out squid_subca.csr -config ca_req.conf
</code></pre>

<h2>ğŸ§± Squid å´ã®è¨­å®š</h2>

<h3>ssl_crtd åˆæœŸåŒ–</h3>
<p><code>ãƒ»ssl_crtd</code> ã¨ã¯ã€Squidã§ SSL Bump ã‚’è¡Œã†éš›ã«ä½¿ã‚ã‚Œã‚‹ã€Œå‹•çš„è¨¼æ˜æ›¸ç”Ÿæˆç”¨ã®è£œåŠ©ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã€ã§ã™ã€‚</p>
<p>ãƒ»SSL Bump ã§ã¯ã€ãƒ—ãƒ­ã‚­ã‚·ãŒä¸­é–“è€…ã¨ã—ã¦é€šä¿¡ã‚’å¾©å·ã™ã‚‹ãŸã‚ã«ã€ã‚¢ã‚¯ã‚»ã‚¹å…ˆã”ã¨ã«ã€Œå½ã®ã‚µãƒ¼ãƒè¨¼æ˜æ›¸ã€ã‚’å‹•çš„ã«ç™ºè¡Œã—ã¾ã™ã€‚<br>
ãƒ»ãã®è¨¼æ˜æ›¸ã‚’å®Ÿéš›ã«ç”Ÿæˆãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ã„ã‚‹ã®ãŒ <code>ssl_crtd</code> ã§ã™ã€‚</p>

<pre><code>SSLDB=/var/lib/ssl_db
mkdir -p ${SSLDB}
chown -R proxy:proxy ${SSLDB}
/usr/lib64/squid/security/ssl_crtd -c -s ${SSLDB}
</code></pre>

<h3>è¨¼æ˜æ›¸é…ç½®</h3>
<p>1. ã‚µãƒ–CAè¨¼æ˜æ›¸ã‚’ <code>/etc/squid/ssl_cert/squid_ca_cert.pem</code> ã«æ›¸ãè¾¼ã¿ã¾ã™ã€‚</p>
<p>2. ãƒ«ãƒ¼ãƒˆCAè¨¼æ˜æ›¸ã‚’ <code>/etc/squid/ssl_cert/squid_ca_cert.pem</code> ã®æœ«å°¾ã«è¿½è¨˜ã—ã€ã€Œè¨¼æ˜æ›¸ãƒã‚§ãƒ¼ãƒ³ã€ã‚’1ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã¾ã™ã€‚<br>
3. ã‚µãƒ–CAã®ç§˜å¯†éµã‚’ <code>.pem</code> å½¢å¼ã§ä¿å­˜ã—ã¾ã™ã€‚ã“ã®éµãŒå®Ÿéš›ã« SSL bump ã§å‹•çš„è¨¼æ˜æ›¸ã‚’ç½²åã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>

<pre><code>cat squid_subca.crt > /etc/squid/ssl_cert/squid_ca_cert.pem
cat root_ca.crt >> /etc/squid/ssl_cert/squid_ca_cert.pem
cat squid_subca.key > /etc/squid/ssl_cert/squid_ca_key.pem
</code></pre>

  <h3>squid.conf è¨­å®šä¾‹</h3>
  <pre><code>http_port 3128
https_port 3129 ssl-bump cert=/etc/squid/ssl_cert/squid_ca.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB

sslcrtd_program /usr/lib/squid/security/ssl_crtd -s /var/lib/ssl_db -M 4MB
sslcrtd_children 8 startup=1 idle=1

acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all

sslproxy_cert_error allow all
sslproxy_flags DONT_VERIFY_PEER
sslproxy_options NO_SSLv3 NO_TLSv1
sslproxy_cipher HIGH:!aNULL:!MD5
</code></pre>

  <h2>ğŸ–¥ï¸ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼šCAä¿¡é ¼ã®é…å¸ƒï¼ˆGPOï¼‰</h2>
  <ol>
    <li>GPO â†’ Computer Configuration â†’ Windows Settings â†’ Security Settings â†’ Public Key Policies â†’ Trusted Root Certification Authorities</li>
    <li>ADCSãƒ«ãƒ¼ãƒˆCAã¾ãŸã¯Squidã‚µãƒ–CAã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</li>
    <li><code>gpupdate /force</code> ã§åæ˜ </li>
    <li>ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ç™ºè¡Œè€…ãŒ <strong>Squid-Proxy-SubCA</strong> ã«ãªã£ã¦ã„ã‚Œã°æˆåŠŸ</li>
  </ol>

  <h2>ğŸ§ª å‹•ä½œç¢ºèª</h2>
  <h3>ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³</h3>
  <pre><code>curl -x http://&lt;squid-ip&gt;:3128 -k https://www.google.com/ -v</code></pre>
  <h3>ãƒ–ãƒ©ã‚¦ã‚¶</h3>
  <p>HTTPS ã‚µã‚¤ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã€è¨¼æ˜æ›¸ç™ºè¡Œè€…ãŒ <strong>Squid-Proxy-SubCA</strong> ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>

  <h2>ğŸ§° ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒˆ</h2>
  <table>
    <tr><th>ç—‡çŠ¶</th><th>åŸå›  / å¯¾å‡¦</th></tr>
    <tr><td>è¨¼æ˜æ›¸ã‚¨ãƒ©ãƒ¼</td><td>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«CAæœªé…å¸ƒï¼ãƒã‚§ãƒ¼ãƒ³ä¸å®Œå…¨</td></tr>
    <tr><td>ssl_crtdã‚¨ãƒ©ãƒ¼</td><td>ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ¨©é™ï¼åˆæœŸåŒ–å¿˜ã‚Œ</td></tr>
    <tr><td>ä¸€éƒ¨ã‚µã‚¤ãƒˆã§ã‚¨ãƒ©ãƒ¼</td><td>HSTSã‚„ãƒ”ãƒ³ç•™ã‚ â†’ <code>ssl_bump splice</code>ã§é™¤å¤–</td></tr>
  </table>

  <pre><code>acl sensitive dstdomain .bank.example
ssl_bump peek step1
ssl_bump splice sensitive
ssl_bump bump all
</code></pre>

  <h2>âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ</h2>
  <div class="checklist">
    <ul>
      <li>ADCS ç®¡ç†è€…æ‰¿èªæ¸ˆã¿</li>
      <li>ã‚µãƒ–CAç™ºè¡Œå®Œäº†</li>
      <li>Squid éµï¼è¨¼æ˜æ›¸é…ç½®</li>
      <li>ssl_crtd åˆæœŸåŒ–</li>
      <li>GPO ã§CAé…å¸ƒ</li>
      <li>ãƒ–ãƒ©ã‚¦ã‚¶ã§ç™ºè¡Œè€…ç¢ºèª</li>
      <li>HSTSã‚µã‚¤ãƒˆé™¤å¤–è¨­å®š</li>
    </ul>
  </div>

  <h2>ğŸ“š è£œè¶³ï¼šè‡ªå·±ç½²åCAæ–¹å¼ï¼ˆç°¡æ˜“æ§‹æˆï¼‰</h2>
  <pre><code>openssl req -new -x509 -days 3650 -newkey rsa:4096 -keyout squid_ca.key -out squid_ca.crt
cat squid_ca.crt squid_ca.key > /etc/squid/ssl_cert/squid_ca.pem
</code></pre>
  <p>GPOã§root_ca.crtã‚’é…å¸ƒã—ã€æ§‹æˆã¯ã‚µãƒ–CAæ–¹å¼ã¨ã»ã¼åŒã˜ã§ã™ã€‚</p>

  <h2>ğŸ“ å‚è€ƒãƒªãƒ³ã‚¯</h2>
  <ul>
    <li><a href="http://www.squid-cache.org/Doc/config/ssl_bump/" target="_blank">Squidå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ â€“ SSL Bump</a></li>
    <li><a href="https://learn.microsoft.com/ja-jp/windows-server/identity/ad-ds/manage/component-updates/enterprise-ca" target="_blank">Microsoft Docs â€“ AD CS ã‚µãƒ–CAã®æ§‹æˆ</a></li>
  </ul>

</main>
</body>
</html>