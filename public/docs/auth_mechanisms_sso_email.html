<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>仕組みで理解する：SSO と メールアドレス認証</title>
  <style>
    body { font-family: "Segoe UI", "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, Arial, sans-serif; background:#ffffff; color:#111; line-height:1.75; margin:0; }
    main { max-width: 980px; margin: 24px auto; padding: 24px; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.06); background:#fff; }
    h1, h2, h3 { color:#0b4a6f; }
    h1 { margin:0 0 10px; }
    h2 { margin:26px 0 8px; }
    h3 { margin:18px 0 6px; }
    p { margin: 0 0 12px; }
    .note { background:#e0f2fe; border-left:6px solid #0ea5e9; padding:12px; border-radius:6px; margin:12px 0; }
    .card { background:#f8fafc; border:1px solid #e2e8f0; border-radius:10px; padding:14px; margin:12px 0; }
    table { width:100%; border-collapse:collapse; margin: 12px 0; font-size:14px; }
    th, td { border:1px solid #e5e7eb; padding:8px; text-align:left; vertical-align:top; }
    th { background:#f1f5f9; }
    code, kbd { background:#f1f5f9; border:1px solid #e5e7eb; padding:2px 6px; border-radius:6px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    pre.seq { background:#0f172a; color:#e5e7eb; border-radius:8px; padding:12px; overflow:auto; border:1px solid #0b4a6f22; }
    ul { margin:8px 0 8px 20px; }
    .cols { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px,1fr)); gap:12px; }
    .summary { background:#fff7ed; border:1px solid #fde68a; border-radius:10px; padding:14px; }
    .pill { display:inline-block; font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#f8fafc; margin-right:6px; }
    .ok { background:#dcfce7; border-color:#86efac; }
    .warn { background:#fffbeb; border-color:#fed7aa; }
  </style>
</head>
<body>
<main>
  <h1>🔐 仕組みで理解する：SSO と メールアドレス認証</h1>
  <p>実装や設計のときに迷いやすい「<b>SSO（SAML/OIDC）</b>」と「<b>メールアドレス認証（マジックリンク/OTP）</b>」の<b>動作の流れ</b>と<b>注意点</b>を、最短で把握できるように整理しました。</p>

  <div class="note">
    <strong>ざっくり結論:</strong>
    <span class="pill ok">社内/B2B → SSO</span>
    <span class="pill warn">B2C/軽量登録 → メール認証</span>
    <span class="pill">どちらも MFA・レート制限・監査ログは必須</span>
  </div>

  <h2>1) SSO（SAML / OpenID Connect）の仕組み</h2>
  <div class="card">
    <h3>登場人物</h3>
    <ul>
      <li><b>ユーザー</b>（ブラウザ/アプリ）</li>
      <li><b>SP/クライアント</b>（あなたのアプリ）</li>
      <li><b>IdP</b>（Entra ID / Okta / Google など認証基盤）</li>
    </ul>
  </div>

  <div class="card">
    <h3>典型フロー（OIDC Authorization Code + PKCE）</h3>
    <pre class="seq">ユーザー → SP: /login を開く
SP → ブラウザ: IdPの認可エンドポイントへリダイレクト(client_id, scope, code_challenge...)
ブラウザ → IdP: ログイン画面（MFA/条件付きアクセス含む）
IdP → ブラウザ: 認可コード付きでSPのredirect_uriへリダイレクト
ブラウザ → SP: redirect_uri?code=...
SP → IdP(Tokenエンドポイント): code + code_verifier を送信しトークン請求
IdP → SP: IDトークン(JWT) + アクセストークン 等を返却
SP: IDトークン検証（署名/exp/aud/iss）、ユーザーをローカルセッションに紐付け
SP → ユーザー: ログイン完了</pre>
    <p>※SAMLの場合は「認証レスポンス（署名付きアサーション）」を受け取り、SPが検証してセッションを張る点が要点。</p>
  </div>

  <div class="cols">
    <div class="card">
      <h3>キーポイント</h3>
      <ul>
        <li>トークンは <b>署名検証</b>（JWKs / x509）。<code>iss</code>/<code>aud</code>/<code>exp</code> を必ず検査。</li>
        <li><b>セッション管理</b>はSP側。短命クッキー＋SameSite/HttpOnly/Secure。</li>
        <li>権限付与は <b>グループ/クレーム</b>（ロール）で行い、アプリ側に反映。</li>
        <li>ユーザー作成/削除は <b>SCIM</b> で自動化がベスト。</li>
      </ul>
    </div>
    <div class="card">
      <h3>セキュリティ注意点</h3>
      <ul>
        <li>認可コード奪取対策：<b>PKCE</b>、<code>redirect_uri</code> の厳格一致。</li>
        <li>トークン漏えい対策：短期有効／ローテーション、<b>バックチャネル</b>で交換。</li>
        <li>フェデレーション障害時の <b>BCP</b>（緊急ログイン/代替IdP）。</li>
        <li>ログ：IdPとSP双方で<b>監査一元化</b>。</li>
      </ul>
    </div>
  </div>

  <h2>2) メールアドレス認証（マジックリンク / ワンタイムコード）の仕組み</h2>
  <div class="card">
    <h3>概要</h3>
    <p>パスワードを使わず、メールで送る <b>一時トークン</b>（リンクまたは数字コード）で本人性を確認する方式。</p>
  </div>

  <div class="card">
    <h3>典型フロー（マジックリンク）</h3>
    <pre class="seq">ユーザー → アプリ: メールアドレス入力
アプリ: 使い捨てトークン(短期有効・1回限り)をDBに保存し、リンクを生成
アプリ → メール: 署名付きURLを送信 (例: https://app.example.com/callback?t=...)
ユーザー → ブラウザ: メールのリンクをクリック
ブラウザ → アプリ: /callback?t=... に到達
アプリ: トークンの有効期限/未使用/端末情報を検証 → ログイン成立
アプリ: ローカルセッション発行（クッキーまたはアプリ内セッション）</pre>
  </div>

  <div class="cols">
    <div class="card">
      <h3>実装の勘所</h3>
      <ul>
        <li><b>有効期限</b>：5〜10分目安。<b>一回限り</b>で失効。</li>
        <li><b>端末バインド</b>：発行時のユーザーエージェント/デバイス情報と突合。</li>
        <li><b>レート制限</b>：同一IP/メール宛の連続送信を抑制。</li>
        <li>メール到達率：<b>SPF/DKIM/DMARC</b> 設定と送信ドメイン監視。</li>
      </ul>
    </div>
    <div class="card">
      <h3>セキュリティ注意点</h3>
      <ul>
        <li>メール乗っ取り・転送経由の漏えいに注意。<b>短命・一回限り・デバイス固定</b>が基本。</li>
        <li>リンク改ざん対策：<b>署名付きトークン</b>（HMAC/JWT）と<code>state</code>等。</li>
        <li>中間者対策：HTTPS必須、<b>SameSite/HttpOnly/Secure</b>クッキー。</li>
        <li>OTP方式では<b>試行回数制限</b>と<b>時刻ズレ耐性</b>の設計。</li>
      </ul>
    </div>
  </div>

  <h2>3) どちらの方式でも押さえる共通ポイント</h2>
  <table>
    <thead>
      <tr><th>項目</th><th>推奨</th></tr>
    </thead>
    <tbody>
      <tr><td>MFA</td><td>必須（TOTP, WebAuthn/パスキー, デバイス認証など）</td></tr>
      <tr><td>セッション</td><td>短寿命・更新型、クッキーは HttpOnly/Secure/SameSite、CSRF対策</td></tr>
      <tr><td>監査</td><td>成功/失敗/多要素/トークン交換/設定変更をログ、相関ID付与</td></tr>
      <tr><td>可用性</td><td>リトライ/冪等性、メール送信・IdPの障害時の退避経路</td></tr>
    </tbody>
  </table>

  <div class="summary">
    <strong>まとめ:</strong> <b>SSO</b>は組織のIdPに統合しガバナンスを効かせるのに最適。<b>メール認証</b>は登録摩擦を最小化できるが、トークンの短期・一回限り・端末バインド・レート制限が鍵。用途に応じて選びつつ、共通でMFA/監査/セッション安全化を徹底しましょう。
  </div>
</main>
</body>
</html>
